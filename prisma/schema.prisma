// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

//declares the database
datasource db {  
  provider = "postgresql"
}

// Create status values
enum GameStatus { =
  BACKLOG
  PLAYING
  FINISHED
  DROPPED
}

//User database table
model User {
  id String @id @default(cuid()) //primary key (prisma auot generates uniquie string id)
  email String @unique // unique user email

  name String? //Display name (better auth)
  emailVerified Boolean @default(false) //(Better auth)
  image String? //optional avatar (better auth)

  sessions Session[] //All login sessions for this user
  account Account[]  //All auth accounts for this user

  username String? @unique //user username
  userGames UserGame[] //User's games library
  list List[] //Users custom list
  createdAt DateTime @default(now()) //Date user was created (default to now)
  updatedAt DateTime @updatedAt //Automatically update whenever row changes
}

model Session {
  id String @id @default(cuid())      //session row id
  userId String                       //FK -> User.id (identify user of session)
  token String @unique                //Session token stored in cookie
  expiresAt DateTime                  //expiry Time for session
  ipAddress String?                   //optional device ip
  userAgent String?                    //optional device UA
  createdAt DateTime @default(now())  //timestamps 
  updatedAt DateTime @updatedAt       //timestamps

  user User @relation(fields: [userId], references: [id], onDelete: Cascade) //link to user

  @@index([userId])                   // fast lookup by user
}

model Account {
  id            String @id @default(cuid())     //account row id
  userId        String                          //fk -> User.id
  accountId     String                          //provider account id
  providerId    String                          //Which proivder (google, github, email/password) the account uses
  
  //optional oauth tokens
  accessToken   String?                         
  refreshToken  String?                         
  accessTokenExpireAt DateTime?                 
  refreshTokenExpireAt DateTime?                
  scope         String?                       
  idToken       String?                         

  password      String?                         //password hash for email/password
  createdAt     DateTime @default(now())        //timestamp
  updatedAt     DateTime @updatedAt             //timestamp

  user          User @relation(fields: [userId], references: [id], onDelete: Cascade) //link to user

  @@index([userId])                             //fast lookup by user
  @@unique([providerId, accountId])             //unique per provider+account
}

model Verification {
  id            String @id @default(cuid())     //verification row id
  identifider   String                          //identifies who/what this verification is for(email or password reset)
  value         String                          //Verification token
  expiresAt     DateTime                        //token expiry time
  createdAt     DateTime @default(now())                //creation timestamp
  updatedAt     DateTime @updatedAt             //update timestamp

  @@index([identifider])                        //Speeds up lookups by email/identifider

}


//Game database table
model Game {
  id String @id @default(cuid()) //primary  key id
  title String //Game title
  coverUrl String? //optional cover art URL (can be null)

  description String? //null for now
  releaseDate DateTime? //null for now
  developer String? //null for now

  ListItem ListItem[] //One game per custom List
  userGames UserGame[] //one game can appear in many users lists
  createdAt DateTime @default(now()) //Date game was created (default to now)
  updatedAt DateTime @updatedAt //Automatically update whenever row changes
}

//Joined game and user table
model UserGame {
  id String @id @default(cuid()) //primary key id for this library entry
  userId String //Foreign key pointing to User.id
  gameId String //Foreign key pointing to Game.id
  status GameStatus @default(BACKLOG) //default a games status to BACKLOG
  platform String? //optional platform specification string
  hoursPlayed Int @default(0) // Number of hours played (default to 0)
  progressPct Int @default(0) //Progress percentage (default to 0)

  user User @relation(fields: [userId], references: [id]) //Defines relation + FK details to User
  game Game @relation(fields: [gameId], references: [id]) //Defines relation + FK details to Game
  
  createdAt DateTime @default(now()) //Date created (default to now)
  updatedAt DateTime @updatedAt //Automatically update whenever row changes

  @@unique([userId, gameId]) //Enforces: a user can only have a given game once in thier library
}

//User created list
model List {
  id String @id @default(cuid()) //unique list id
  userId String //User who owns the list
  name String //Name of the list
  descirption String? //optional description for the list
  isPublic Boolean //Ability to set list public or not
  createdAt DateTime @default(now()) //When the list was created
  updatedAt DateTime @updatedAt //Time it was updatedAt

  user User @relation(fields: [userId], references: [id]) //connect list -> user
  items ListItem[] //All items that belong to this list
}

// Join table: Games inside list
model ListItem {
  id String @id @default(cuid()) //Row id //IF MIGRATION ERROS I JUST ADDED @id
  listId String //Foreign key of which custom list (list.id)
  gameId String //Foreign key of which game in row (game.id)
  position Int? //Optional ordering later (drag/drop, manual sort)
  createdAt DateTime @default(now()) //Time created

  list List @relation(fields: [listId], references: [id]) //connect item to list
  game Game @relation(fields: [gameId], references: [id]) //connects item to game

  @@unique([listId, gameId]) //Prevent duplicates of the same game in one list
}

